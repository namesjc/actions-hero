# .github/workflows/create-branch.yml
name: Create Branch, Commit Changes, and PR via Script (with PAT)

# Controls when the workflow will run
on:
  workflow_dispatch: # Allows manual triggering
    inputs:
      new_branch_name:
        description: "Name for the new branch (e.g., feature/my-new-feature)"
        required: true
        default: "feature/new-branch"
      base_branch_name:
        description: "Branch to base the new branch on AND target for the PR"
        required: true
        default: "main" # Or your default branch
      commit_message:
        description: "Commit message for the automated change"
        required: false
        default: "feat: Add placeholder file"
      # pr_title:
      #   description: "Title for the Pull Request"
      #   required: false # Optional, provide a default
      #   default: "New Feature Branch"
      # pr_body:
      #   description: "Body/description for the Pull Request"
      #   required: false # Optional
      #   default: "Pull request automatically created by workflow."
      automerge-allow:
        description: "Allow automatic merge of Pull Request"
        default: false
        type: string
      reviewers:
        description: 'Comma-separated list of GitHub usernames to request reviews from (e.g., user1,user2)'
        required: false
        default: ''
      merge_method:
        description: 'Merge method (merge, squash, rebase)'
        required: false
        default: 'merge'
        type: choice
        options:
        - merge
        - squash
        - rebase

jobs:
  create_branch_commit_pr_job:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Create new branch
        id: create_branch
        uses: actions/github-script@v7
        with:
          # github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Get inputs from the workflow_dispatch event
            const newBranch = '${{ github.event.inputs.new_branch_name }}';
            const baseBranch = '${{ github.event.inputs.base_branch_name }}';
            const repoUrl = context.payload.repository.html_url;
            const ref = `refs/heads/${newBranch}`;

            console.log(`Creating branch '${newBranch}' from '${baseBranch}'...`);

            try {
              // Fetch the SHA of the base branch
              const { data: baseBranchRef } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `heads/${baseBranch}`,
              });
              const baseSha = baseBranchRef.object.sha;

              // Create the new branch
              await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: ref,
              sha: baseSha,
              });

              const branchUrl = `${repoUrl}/tree/${newBranch}`;
              console.log(`Branch '${newBranch}' created successfully.`);

              // Update summary and outputs
              core.summary
              .addHeading('Branch Creation', 3)
              .addRaw(`\n`)
              .addRaw(`* ✅ Successfully created branch: `)
              .addLink(`${newBranch}`, `${branchUrl}`)
              .addRaw(`* Base Branch: \`${baseBranch}\``, true)
              .addSeparator();
              await core.summary.write({ overwrite: false });

              core.setOutput("new_branch_name_output", newBranch);
            } catch (error) {
              console.error(`Failed to create branch: ${error.message}`);

              // Update summary with error details
              core.summary
              .addHeading('Branch Creation', 3)
              .addRaw(`\n`)
              .addRaw(`* ❌ Failed to create branch '${newBranch}'. Error: ${error.message}`, true)
              .addSeparator();
              await core.summary.write();

              // Handle specific error cases
              if (error.status === 422) {
              core.setFailed(`Branch '${newBranch}' already exists. Error: ${error.message}`);
              } else {
              core.setFailed(`Error creating branch '${newBranch}': ${error.message}`);
              }
            }

      - name: Checkout new branch
        if: success() && steps.create_branch.outputs.new_branch_name_output
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.create_branch.outputs.new_branch_name_output }}
          fetch-depth: 1

      - name: Create commit
        id: create_commit
        if: success()
        run: |
          echo "Adding a new line generated by workflow at $(date)" >> README.md
          # Or create a new file:
          # echo "This file was created by the workflow" > generated-file-${{ github.run_id }}.txt

          # Configure Git
          # Use the GitHub Actions bot user as the committer
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Commit the changes
          git add . # Add all changes

          if git diff --staged --quiet; then
            echo "No changes to commit."
            echo "commit_sha=NONE" >> $GITHUB_OUTPUT # Set output even if no commit
          else
            git commit -m "${{ github.event.inputs.commit_message }}" # Use input for commit message
            git push origin ${{ steps.create_branch.outputs.new_branch_name_output }}
            COMMIT_SHA=$(git rev-parse HEAD) # Get the SHA of the new commit
            echo "Changes committed and pushed to ${{ steps.create_branch.outputs.new_branch_name_output }}. Commit SHA: $COMMIT_SHA"
            echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT # Output the commit SHA
          fi

      - name: Update Summary with Commit Info
        if: always() && steps.create_branch.outcome != 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const commitSha = '${{ steps.create_commit.outputs.commit_sha }}';
            const branchName = '${{ steps.create_branch.outputs.new_branch_name_output }}';
            const repoUrl = context.payload.repository.html_url;

            core.summary.addHeading('Commit Details', 3).addRaw('\n');

            if (!commitSha || commitSha === 'NONE') {
              const message = commitSha === 'NONE'
              ? `* ℹ️ No file changes detected; no commit was created on branch \`${branchName}\``
              : `* ❌ Failed to get commit details for branch \`${branchName}\` (Step likely failed)`;
              core.summary.addRaw(message, true);
            } else {
              const commitUrl = `${repoUrl}/commit/${commitSha}`;
              core.summary.addRaw(`* ✅ Commit [${commitSha.substring(0, 7)}](${commitUrl})`)
                  .addRaw(` pushed to branch \`${branchName}\``, true);
            }

            core.summary.addSeparator();
            await core.summary.write({ overwrite: false });

      - name: Create Pull Request
        id: create_pr
        if: success() && steps.create_commit.outputs.commit_sha && steps.create_commit.outputs.commit_sha != 'NONE'
        uses: actions/github-script@v7
        with:
          # github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const newBranch = '${{ steps.create_branch.outputs.new_branch_name_output }}';
            const baseBranch = '${{ github.event.inputs.base_branch_name }}';
            const runNumber = context.runNumber;
            const repoUrl = context.payload.repository.html_url;
            const prTitle = `Version Picker changes: Run#${runNumber}`;
            const prBody = `
              Version Picker changes:
              - **Run Number**: [${runNumber} - Overview](${repoUrl}/actions/runs/${context.runId})
              - **Run ID**: ${context.runId}
              - **Date**: ${new Date().toISOString().replace('T', ' ').slice(0, 19)}
            `.trim();
            const reviewersInput = '${{ github.event.inputs.reviewers }}'; // Get reviewers input

            // Prepare reviewers array
            const reviewers = reviewersInput ? reviewersInput.split(',').map(r => r.trim()).filter(r => r) : [];

            console.log(`Creating Pull Request for branch '${newBranch}' targeting '${baseBranch}'...`);

            try {
              const { data: pullRequest } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: prTitle,
              head: newBranch,
              base: baseBranch,
              body: prBody,
              draft: false,
              });

              const prUrl = pullRequest.html_url;
              const prNumber = pullRequest.number;

              console.log(`Successfully created Pull Request #${prNumber}: ${prUrl}`);
              core.setOutput("pr_url", prUrl);
              core.setOutput("pr_number", prNumber);

              core.summary
              .addHeading('Pull Request Creation', 3)
              .addRaw('\n')
              .addRaw(`* ✅ Successfully created Pull Request `)
              .addLink(`#${prNumber}`, prUrl)
              .addRaw(`* Target Branch: \`${baseBranch}\``, true)

              if (reviewers.length > 0) {
                console.log(`Attempting to add reviewers: ${reviewers.join(', ')}`);
                try {
                  await github.rest.pulls.requestReviewers({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: prNumber,
                    reviewers: reviewers
                  });
                  console.log(`Successfully requested reviews from: ${reviewers.join(', ')}`);
                  core.summary.addRaw(`* Requested reviewers: ${reviewers.map(r => `\`${r}\``).join(', ')}`, true);
                } catch (reviewError) {
                   console.error(`Error requesting reviewers: ${reviewError.message}`);
                   core.warning(`Failed to add reviewers: ${reviewError.message}`);
                   core.summary.addRaw(`* ⚠️ Failed to add reviewers: ${reviewError.message}\n`);
                }
              }

              core.summary.addSeparator();
              await core.summary.write({ overwrite: false });
            } catch (error) {
              console.error(`Failed to create Pull Request: ${error.message}`);

              const errorMsg = `Failed to create Pull Request for branch \`${newBranch}\` targeting \`${baseBranch}\``;
              core.summary
              .addHeading('Pull Request Creation', 3)
              .addRaw('\n')
              .addRaw(`* ❌ ${errorMsg}`, true)
              .addRaw(`Error: ${error.message}`, true);

              if (error.message.includes("A pull request already exists")) {
              core.summary.addRaw(`* ℹ️ An active pull request likely already exists for this branch.`, true);
              core.warning(`PR already exists for branch \`${newBranch}\``);
              } else if (error.message.includes("No commits between")) {
              core.summary.addRaw(`* ℹ️ No commits between \`${newBranch}\` and \`${baseBranch}\``, true);
              core.warning(`No commits between '${newBranch}' and '${baseBranch}'.`);
              } else {
              core.setFailed(`Error creating Pull Request: ${error.message}`);
              }

              core.summary.addSeparator();
              await core.summary.write({ overwrite: false });
            }

      - name: Merge Pull Request
        id: merge_pr
        # Only run if PR creation step succeeded and produced a PR number
        if: success() && inputs.automerge-allow == 'true' && steps.create_pr.outputs.pr_number && steps.create_pr.outputs.pr_number != 'NONE'
        uses: actions/github-script@v7
        with:
          # github-token: ${{ secrets.GH_PAT }}
          script: |
            const prNumber = ${{ steps.create_pr.outputs.pr_number }};
            const mergeMethod = '${{ inputs.merge_method }}';
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            console.log(`Attempting to merge Pull Request #${prNumber} using method '${mergeMethod}'...`);

            try {
              const response = await github.rest.pulls.merge({
                owner: owner,
                repo: repo,
                pull_number: prNumber,
                merge_method: mergeMethod, // 'merge', 'squash', or 'rebase'
              });

              console.log('::response::');
              console.log(response);

              if (response.status === 200 && response.data.merged) {
                  const mergeCommitSha = response.data.sha;
                  const repoUrl = context.payload.repository.html_url;
                  const mergeCommitUrl = `${repoUrl}/commit/${mergeCommitSha}`;
                  const successMsg = `Successfully merged Pull Request #${prNumber}. Merge commit: [${mergeCommitSha.substring(0,7)}](${mergeCommitUrl})`;
                  console.log(successMsg);
                  core.setOutput("merge_commit_sha", mergeCommitSha);

                  core.summary
                  .addHeading('Pull Request Merge', 3)
                  .addRaw('\n')
                  .addRaw(`* ✅ ${successMsg}`, true)
                  .addRaw(`* Method: \`${mergeMethod}\``, true)
                  .addSeparator();
                  await core.summary.write({ overwrite: false });
              } else {
                  const failureMsg = `Pull Request #${prNumber} could not be merged. Response status: ${response.status}. Message: ${response.data.message || 'No specific message.'}`;
                  console.warn(failureMsg);
                  core.warning(failureMsg);

                  core.summary
                  .addHeading('Pull Request Merge', 3)
                  .addRaw('\n')
                  .addRaw(`* ⚠️ ${failureMsg}`, true)
                  .addSeparator();
                  await core.summary.write({ overwrite: false });
              }

            } catch (error) {
              console.error(`Error merging Pull Request #${prNumber}: ${error.message}`);
              const errorMsg = `Failed to merge Pull Request #${prNumber}.`;

              core.summary
              .addHeading('Pull Request Merge', 3)
              .addRaw('\n')
              .addRaw(`* ❌ ${errorMsg} Error: ${error.message}`, true)
              .addSeparator();
              await core.summary.write({ overwrite: false });

              if (error.message.includes("Pull Request is not mergeable")) {
                core.warning(`${errorMsg} It's not in a mergeable state (e.g., conflicts, checks pending/failed).`);
              } else if (error.status === 404) {
                 core.setFailed(`${errorMsg} Pull Request not found.`);
              }
              else {
                core.setFailed(`${errorMsg} Error: ${error}`);
              }
            }

      - name: Delete Branch
        if: ${{ success() && steps.merge_pr.outputs.merge_commit_sha }}
        uses: actions/github-script@v7
        with:
          # github-token: ${{ secrets.GH_PAT }}
          script: |
            const branchName = '${{ steps.create_branch.outputs.new_branch_name_output }}';
            const ref = `heads/${branchName}`;
            console.log(`Attempting to delete branch '${branchName}'...`);
            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: ref,
              });
              console.log(`Successfully deleted branch '${branchName}'.`);
              core.summary
              .addHeading('Branch Deletion', 3)
              .addRaw('\n')
              .addRaw(`* ✅ Successfully deleted branch \`${branchName}\`.`, true)
              .addSeparator();
              await core.summary.write({ overwrite: false });
            } catch (error) {
              console.error(`Error deleting branch '${branchName}': ${error.message}`);
              core.warning(`Failed to delete branch '${branchName}'. Error: ${error.message}`);
              core.summary
              .addHeading('Branch Deletion', 3)
              .addRaw('\n')
              .addRaw(`* ⚠️ Failed to delete branch \`${branchName}\`. Error: ${error.message}`, true)
              .addSeparator();
              await core.summary.write({ overwrite: false });
            }
